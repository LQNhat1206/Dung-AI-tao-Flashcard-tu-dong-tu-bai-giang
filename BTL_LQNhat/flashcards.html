<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flashcard Sinh Vi√™n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#ffe6f7,#e0f7fa);color:#333}
    .page-wrap{max-width:1200px;margin:0 auto;padding:0 16px}
    /* Card flip */
    .flip-card{perspective:1200px; width:300px; min-width:260px; margin:0 auto;}
    /* tƒÉng min-height ƒë·ªÉ ƒë·ªß kh√¥ng gian cho question + options */
    .flip-card-inner{position:relative;width:100%;min-height:380px;transition:transform .8s ease-in-out;transform-style:preserve-3d}
    .flip-card.flipped .flip-card-inner{transform:rotateY(180deg)}
    .flip-card-front,.flip-card-back{
      position:absolute;inset:0;backface-visibility:hidden;border-radius:16px;
      box-shadow:0 12px 25px rgba(0,0,0,.15);
      /* X·∫øp d·ªçc: question tr√™n, options d∆∞·ªõi; gap ƒë·ªÉ tr√°nh ch·ªìng ch·ªØ */
      display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;
      padding:18px 18px 14px 18px;text-align:left;gap:12px;overflow:hidden;box-sizing:border-box;
    }
    .flip-card-front{background:linear-gradient(145deg,#fff4e6,#ffe6f7);border:2px solid #ff8fab;color:#222}
    .flip-card-back{background:linear-gradient(145deg,#e0f7fa,#fffde7);border:2px solid #80deea;color:#065f46;transform:rotateY(180deg)}
    /* Responsive question: auto scale + clamp lines */
    .question{
      font-size:clamp(1rem,1.6vw,1.15rem);
      font-weight:800;margin:0;padding:6px 6px 0 6px;
      display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;
      -webkit-line-clamp:3; /* show max 3 lines by default */
      word-break:break-word; hyphens:auto; cursor:pointer;
      width:100%; text-align:left;
      /* ch·∫Øc ch·∫Øn question kh√¥ng b·ªã ƒë√®: ƒë·∫∑t position relative */
      position:relative; z-index:1;
    }
    .question.expanded{
      -webkit-line-clamp:unset; overflow:visible; white-space:normal;
    }

    /* wrapper cho c√°c l·ª±a ch·ªçn: ƒë·∫£m b·∫£o hi·ªÉn th·ªã ph√≠a d∆∞·ªõi v√† scroll khi c·∫ßn */
    .options-wrapper{display:flex;flex-direction:column;align-items:stretch;gap:8px;margin-top:8px;width:100%;max-height:180px;overflow:auto;padding-right:6px;box-sizing:border-box;}

    .option{
      width:100%; /* ƒë·∫ßy ƒë·ªß chi·ªÅu ngang trong wrapper */
      background:rgba(255,255,255,.95);border:2px solid #e5e7eb;
      margin:0;padding:10px 12px;border-radius:10px;cursor:pointer;transition:.25s;font-weight:600;
      box-sizing:border-box; text-align:center;
    }
    .option:hover{background:#fce4ec;border-color:#f48fb1}
    .option.correct{background:#c8e6c9;border-color:#388e3c;color:#1b5e20}
    .option.wrong{background:#ffcdd2;border-color:#c62828;color:#b71c1c}
    .option.disabled{pointer-events:none;opacity:.85;border-style:dashed;color:#9c3a3a}
    .no-options{
      width:100%;padding:12px;border-radius:10px;margin:10px 0;
      border:2px dashed rgba(244,143,177,.6);background:linear-gradient(180deg,#fff,#fff);
      color:#c62828;font-weight:700;text-align:center;box-sizing:border-box;
    }
    .speak-btn{
      margin-top:8px;background:#ff80ab;color:#fff;border:none;padding:8px 14px;border-radius:10px;
      cursor:pointer;transition:.25s;font-weight:700;align-self:center;
    }
    .speak-btn:hover{background:#f50057}

    /* small helper */
    .expand-btn{font-size:.85rem;color:#6b21a8;background:transparent;border:0;cursor:pointer;text-decoration:underline;margin-top:6px}

    /* modal (AI) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:white;border-radius:12px;padding:18px;width:95%;max-width:720px;box-shadow:0 20px 50px rgba(0,0,0,.3)}
    .modal textarea{width:100%;min-height:160px;border:1px solid #e5e7eb;border-radius:8px;padding:8px;resize:vertical}
    .loader{display:inline-block;width:18px;height:18px;border:3px solid #eee;border-top-color:#ff80ab;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ensure header above content if sticky */
    header{position:sticky;top:0;z-index:50}
    main{padding-top:18px}
  </style>
</head>
<body class="min-h-screen">
  <!-- HEADER -->
  <header class="bg-pink-500 text-white py-4 shadow-lg">
    <div class="page-wrap flex items-center justify-between gap-3">
      <h1 class="text-2xl font-extrabold tracking-wide">üéì Flashcard Sinh Vi√™n</h1>
      <div class="flex gap-2 flex-wrap">
        <button type="button" onclick="openAiModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">ü§ñ T√≥m t·∫Øt b√†i b·∫±ng AI</button>
        <button type="button" onclick="addRandomCards()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow">+ Th√™m c√¢u h·ªèi</button>
        <button type="button" onclick="clearAll()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow">üóë X√≥a t·∫•t c·∫£</button>
        <button type="button" onclick="location.reload()" class="bg-rose-700 hover:bg-rose-800 text-white px-4 py-2 rounded-lg shadow">Tho√°t</button>
      </div>
    </div>
  </header>

  <!-- GRID -->
  <main class="page-wrap py-6">
    <div id="flashcards" class="grid gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"></div>
  </main>

  <!-- AI Modal -->
  <div id="aiModal" class="hidden">
    <div class="modal-backdrop" onclick="closeAiModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">T·∫°o t√≥m t·∫Øt b·∫±ng AI</h2>
          <button onclick="closeAiModal()" class="text-gray-600">ƒê√≥ng ‚úï</button>
        </div>
        <p class="text-sm text-gray-600 mt-2">D√°n n·ªôi dung b√†i gi·∫£ng (ho·∫∑c URL / slide) v√†o √¥ b√™n d∆∞·ªõi. Ch·ªçn ki·ªÉu t√≥m t·∫Øt v√† nh·∫•n T·∫°o.</p>
        <textarea id="lectureText" placeholder="D√°n n·ªôi dung ·ªü ƒë√¢y..."></textarea>
        <div class="mt-3 flex items-center gap-2">
          <select id="summaryStyle" class="border rounded px-2 py-1">
            <option value="short">Ng·∫Øn (3-5 c√¢u)</option>
            <option value="bullets">G·∫°ch ƒë·∫ßu d√≤ng</option>
            <option value="detailed">Chi ti·∫øt (1 ƒëo·∫°n)</option>
          </select>
          <button id="generateBtn" onclick="createSummary()" class="bg-indigo-600 text-white px-3 py-1 rounded">T·∫°o t√≥m t·∫Øt</button>
          <div id="aiStatus" class="ml-2 text-sm"></div>
        </div>
        <div id="summaryResult" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    
    let flashcards = [];

    // Ch·ªçn gi·ªçng Vi·ªát n·∫øu c√≥
    let viVoice = null;
    function pickViVoice(){
      const voices = window.speechSynthesis.getVoices();
      viVoice = voices.find(v => (v.lang||'').toLowerCase().startsWith('vi'))
             || voices.find(v => /viet|vi·ªát/i.test(v.name||'')) || null;
    }
    speechSynthesis.onvoiceschanged = pickViVoice; pickViVoice();

    function handleSpeak(ev, encoded){
      ev.stopPropagation();
      const text = decodeURIComponent(encoded||'');
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'vi-VN';
      if (viVoice) msg.voice = viVoice;
      speechSynthesis.cancel();
      speechSynthesis.speak(msg);
    }

    // Ng√¢n h√†ng c√¢u h·ªèi (gi·ªØ nguy√™n ho·∫∑c m·ªü r·ªông)
    const questionBank = [
      { question:"K·ªπ nƒÉng n√†o ƒë∆∞·ª£c coi l√† quan tr·ªçng nh·∫•t ƒë·ªëi v·ªõi sinh vi√™n trong th·∫ø k·ª∑ 21?",
        options:["K·ªπ nƒÉng ghi nh·ªõ","T∆∞ duy ph·∫£n bi·ªán","Ng·ªìi nghe th·ª• ƒë·ªông","L√†m vi·ªác c√° nh√¢n"],
        answer:"T∆∞ duy ph·∫£n bi·ªán",
        explanation:"Sinh vi√™n c·∫ßn t∆∞ duy ph·∫£n bi·ªán ƒë·ªÉ ph√¢n t√≠ch v√† ƒë√°nh gi√° th√¥ng tin, kh√¥ng ch·ªâ ghi nh·ªõ."},
      { question:"Trong h·ªçc thu·∫≠t, 'ƒë·∫°o vƒÉn' (plagiarism) nghƒ©a l√† g√¨?",
        options:["Vi·∫øt lu·∫≠n vƒÉn","T·ª± s√°ng t·∫°o","Sao ch√©p kh√¥ng tr√≠ch d·∫´n","Th·∫£o lu·∫≠n nh√≥m"],
        answer:"Sao ch√©p kh√¥ng tr√≠ch d·∫´n",
        explanation:"ƒê·∫°o vƒÉn l√† l·∫•y n·ªôi dung/√Ω t∆∞·ªüng c·ªßa ng∆∞·ªùi kh√°c m√† kh√¥ng ghi ngu·ªìn."},
      { question:"Nh√† vƒÉn n√†o ƒë∆∞·ª£c coi l√† '√¥ng ho√†ng truy·ªán ng·∫Øn' Vi·ªát Nam?",
        options:["Nguy·ªÖn Du","Nam Cao","Nguy·ªÖn Huy Thi·ªáp","Kim L√¢n"],
        answer:"Nam Cao",
        explanation:"Nam Cao n·ªïi b·∫≠t v·ªõi truy·ªán ng·∫Øn hi·ªán th·ª±c ph√™ ph√°n s√¢u s·∫Øc."},
      { question:"V√≠ d·ª•: c√¢u h·ªèi ch∆∞a c√≥ l·ª±a ch·ªçn", options:[], answer:"", explanation:"V√≠ d·ª• minh h·ªça cho tr∆∞·ªùng h·ª£p kh√¥ng c√≥ options."},
      { question:"Trong lƒ©nh v·ª±c c√¥ng ngh·ªá, 'Big Data' d√πng ƒë·ªÉ ch·ªâ?",
        options:["D·ªØ li·ªáu nh·ªè","D·ªØ li·ªáu kh·ªïng l·ªì","·ª®ng d·ª•ng vƒÉn ph√≤ng","M√°y t√≠nh c√° nh√¢n"],
        answer:"D·ªØ li·ªáu kh·ªïng l·ªì",
        explanation:"Big Data l√† t·∫≠p d·ªØ li·ªáu c·ª±c l·ªõn, ph·ª©c t·∫°p, c·∫ßn c√¥ng ngh·ªá ƒë·∫∑c bi·ªát ƒë·ªÉ x·ª≠ l√Ω."},
      { question:"Nh√¢n v·∫≠t n√†o trong 'V·ª£ nh·∫∑t' c·ªßa Kim L√¢n ƒë√£ l·∫•y v·ª£ trong n·∫°n ƒë√≥i 1945?",
        options:["Tr√†ng","Ch√≠ Ph√®o","Th·ªã N·ªü","L√£o H·∫°c"],
        answer:"Tr√†ng",
        explanation:"Tr√†ng l·∫•y v·ª£ gi·ªØa n·∫°n ƒë√≥i, th·ªÉ hi·ªán kh√°t v·ªçng s·ªëng."},
      { question:"Khi l√†m vi·ªác nh√≥m, y·∫øu t·ªë n√†o gi√∫p nh√≥m ho·∫°t ƒë·ªông hi·ªáu qu·∫£ nh·∫•t?",
        options:["Ng·ªìi im l·∫∑ng","L·∫Øng nghe v√† t√¥n tr·ªçng √Ω ki·∫øn","√Åp ƒë·∫∑t √Ω ki·∫øn","Tr√°nh tranh lu·∫≠n"],
        answer:"L·∫Øng nghe v√† t√¥n tr·ªçng √Ω ki·∫øn",
        explanation:"Giao ti·∫øp v√† l·∫Øng nghe gi√∫p nh√≥m ph√°t tri·ªÉn √Ω t∆∞·ªüng chung."},
      { question:"Trong Excel, ph√≠m t·∫Øt ƒë·ªÉ sao ch√©p l√† g√¨?",
        options:["Ctrl + Z","Ctrl + C","Ctrl + V","Ctrl + X"],
        answer:"Ctrl + C",
        explanation:"Ctrl + C l√† ph√≠m t·∫Øt chu·∫©n ƒë·ªÉ sao ch√©p."},
      { question:"GPA l√† vi·∫øt t·∫Øt c·ªßa c·ª•m t·ª´ n√†o?",
        options:["General Point Average","Grade Point Average","Global Point Average","Graduate Performance Average"],
        answer:"Grade Point Average",
        explanation:"GPA = ƒëi·ªÉm trung b√¨nh h·ªçc t·∫≠p theo thang ƒëi·ªÉm chu·∫©n."}
    ];

    function renderFlashcards(){
      const box = document.getElementById('flashcards');
      box.innerHTML = '';
      flashcards.forEach((card, i) => {
        const hasOpts = Array.isArray(card.options) && card.options.length > 0;
        // b·ªçc options v√†o wrapper ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã d∆∞·ªõi question
        const opts = hasOpts ? `<div class="options-wrapper">${card.options.map(opt => `
          <div class="option" onclick="checkAnswer(this,'${encodeURIComponent(opt)}','${encodeURIComponent(card.answer||'')}',${i})">${escapeHtml(opt)}</div>
        `).join('')}</div>` : `<div class="options-wrapper"><div class="no-options">Kh√¥ng c√≥ ƒë√°p √°n ƒë·ªÉ ch·ªçn</div></div>`;

        // n·∫øu kh√¥ng c√≥ options, th√™m n√∫t xem ƒë√°p √°n (m·ªü m·∫∑t sau)
        const showAnswerBtn = hasOpts ? '' : `<button type="button" class="speak-btn" onclick="flipCard(${i})">üîç Xem ƒë√°p √°n</button>`;

        box.innerHTML += `
          <div class="flip-card" id="card-${i}">
            <div class="flip-card-inner">
              <div class="flip-card-front">
                <p class="question" id="q-${i}" onclick="toggleExpand(${i})">‚ö° ${escapeHtml(card.question)}</p>
                ${opts}
                <div style="display:flex;justify-content:center;width:100%">
                  <button type="button" class="speak-btn" onclick="handleSpeak(event,'${encodeURIComponent(card.question||'')}')">üîä ƒê·ªçc c√¢u h·ªèi</button>
                </div>
                ${showAnswerBtn}
              </div>
              <div class="flip-card-back">
                <p><b>ƒê√°p √°n ƒë√∫ng:</b> ${escapeHtml(card.answer || 'Ch∆∞a c√≥ ƒë√°p √°n')}</p>
                <p class="mt-2 italic max-w-[90%]">${escapeHtml(card.explanation||'')}</p>
                <button type="button" class="speak-btn" onclick="handleSpeak(event,'${encodeURIComponent('ƒê√°p √°n ƒë√∫ng l√†: ' + (card.answer||'Ch∆∞a c√≥ ƒë√°p √°n') + '. ' + (card.explanation||''))}')">üîä ƒê·ªçc ƒë√°p √°n</button>
              </div>
            </div>
          </div>`;
      });
    }

    // prevent XSS-ish content in innerHTML injection
    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function checkAnswer(el, chosenEnc, correctEnc, index){
      const chosen = decodeURIComponent(chosenEnc);
      const correct = decodeURIComponent(correctEnc);
      el.parentElement.querySelectorAll('.option').forEach(o=>o.classList.remove('wrong'));
      // n·∫øu kh√¥ng c√≥ ƒë√°p √°n ƒë√∫ng ƒë∆∞·ª£c c√†i (correct empty) -> show tr·∫°ng th√°i v√† l·∫≠t sang m·∫∑t sau
      if(!correct){
        el.classList.add('wrong');
        el.parentElement.querySelectorAll('.option').forEach(o=>o.style.pointerEvents='none');
        setTimeout(()=>flipCard(index), 700);
        return;
      }
      if(chosen === correct){
        el.classList.add('correct');
        el.parentElement.querySelectorAll('.option').forEach(o=>o.style.pointerEvents='none');
        setTimeout(()=>flipCard(index), 600);
      }else{
        el.classList.add('wrong');
      }
    }

    function flipCard(index){
      document.getElementById('card-'+index).classList.add('flipped');
    }

    function toggleExpand(index){
      const q = document.getElementById('q-'+index);
      if(!q) return;
      q.classList.toggle('expanded');
    }

    // Th√™m ng·∫´u nhi√™n t·ª´ ng√¢n h√†ng, tr√°nh tr√πng c√¢u h·ªèi ƒë√£ c√≥
    function addRandomCards(){
      const count = parseInt(prompt('B·∫°n mu·ªën th√™m bao nhi√™u c√¢u h·ªèi?', 4),10);
      if (isNaN(count) || count <= 0){ alert('S·ªë kh√¥ng h·ª£p l·ªá!'); return; }

      const currentQs = new Set(flashcards.map(c=>c.question));
      const pool = questionBank.filter(q=>!currentQs.has(q.question));
      if (pool.length === 0){ alert('H·∫øt c√¢u h·ªèi trong ng√¢n h√†ng!'); return; }

      const shuffled = [...pool].sort(()=>Math.random()-0.5);
      const toAdd = shuffled.slice(0, Math.min(count, shuffled.length));
      flashcards = [...flashcards, ...toAdd];
      renderFlashcards();
      document.getElementById('flashcards').scrollIntoView({behavior:'smooth',block:'start'});
    }

    function clearAll(){
      if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ flashcards?')){
        flashcards = [];
        renderFlashcards();
      }
    }

    // Kh·ªüi t·∫°o ‚Äî HI·ªÜN 4 C√ÇU KHI M·ªû TRANG
    flashcards = questionBank.slice(0,3);
    renderFlashcards();

    /* ---------------- AI modal + g·ªçi server ---------------- */
    function openAiModal(){ document.getElementById('aiModal').classList.remove('hidden'); }
    function closeAiModal(ev){
      if(ev && ev.target && ev.target.classList && ev.target.classList.contains('modal-backdrop')) return; // click on backdrop allowed
      document.getElementById('aiModal').classList.add('hidden');
      document.getElementById('aiStatus').innerHTML='';
      document.getElementById('summaryResult').innerHTML='';
    }

    async function createSummary(){
      const text = document.getElementById('lectureText').value.trim();
      const style = document.getElementById('summaryStyle').value;
      if(!text){ alert('Vui l√≤ng d√°n n·ªôi dung b√†i gi·∫£ng v√†o √¥'); return; }
      const status = document.getElementById('aiStatus');
      const btn = document.getElementById('generateBtn');
      status.innerHTML = '<span class="loader" aria-hidden="true"></span> ƒêang t·∫°o...';
      btn.disabled = true;
      try{
        const resp = await fetch('/api/summarize', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ text, style })
        });
        const data = await resp.json();
        if(resp.ok){
          document.getElementById('summaryResult').innerHTML = `<h3 class="font-bold">K·∫øt qu·∫£</h3><div class="mt-2 whitespace-pre-wrap">${escapeHtml(data.summary)}</div>`;
        } else {
          document.getElementById('summaryResult').innerHTML = `<div class="text-red-600">L·ªói: ${escapeHtml(data.error || JSON.stringify(data))}</div>`;
        }
      }catch(err){
        document.getElementById('summaryResult').innerHTML = `<div class="text-red-600">L·ªói khi g·ªçi server: ${escapeHtml(err.message||err)}</div>`;
      }finally{
        status.innerHTML='';
        btn.disabled = false;
      }
    }
  </script>
</body>

</html>
